---
title: "Simulations de données spatialisé sous modèles spatial"
output: html_notebook
---

# Bibliothèque
```{r, warning = FALSE, message= FALSE}
library(INLA)
library(inlabru)
library(dplyr)
library(ggplot2)
library(fields)
library(furrr)
library(knitr)

#fonction perso
source("C:/Users/jerem/Documents/1INLA_RSR_SPATIAL/Spatial/Code/function.R")

#seed
#set.seed(19111997)  # Set seed for reproducibility
```

# Paramètres fixe
```{r}
n=500
n_sim = 50
range.u = 7
sigma.u = 3
prior.median.range = 5
prior.median.sd = 1
beta = 3
alpha = 2
```


# Mesh
```{r}
fake.locations = matrix(c(0,0,10,10, 0, 10, 10, 0), nrow = 4, byrow = T)
crs1 <- inla.CRS("EPSG:4326")
mesh.sim = inla.mesh.2d(loc = fake.locations, max.edge=c(0.61, 1), crs = crs1)
ggplot()+
  gg(mesh.sim)
```

# SPDE
```{r, warning= FALSE}
# Simulate spatial field
seed <- 7#sample(n, 1)

spde_xs = inla.spde2.pcmatern(mesh.sim, alpha = 2, prior.range = c(.5, .5), prior.sigma = c(.5, .5))

Qu_xs = inla.spde.precision(spde_xs, theta=c(2, .4))

u_xs <- inla.qsample(n=1, Q=Qu_xs, seed = seed)

spde_s = inla.spde2.pcmatern(mesh.sim, alpha = 2, prior.range = c(.5, .5), prior.sigma = c(.5, .5))

Qu_s = inla.spde.precision(spde_s, theta=c(0, 1))

u_s <- inla.qsample(n=1, Q=Qu_s, seed = seed)

```

# Plot field
```{r}
local.plot.field(u_xs[,1]- mean(u_xs[,1]), mesh.sim)
local.plot.field(u_s[,1] - mean(u_s[,1]), mesh.sim)
```


# Simulate at measurement locations
```{r}
set.seed(123)

u_s_xs <- matrix(data = NA, nrow=n, ncol=n_sim)
loc.data <- c()
for(i in 1:n_sim){
  set.seed(i)
  loc.data[[i]] = matrix(runif(2*n), n)*10 
  A = inla.spde.make.A(mesh=mesh.sim, loc=loc.data[[i]])
  u_s_xs[,i] = drop(A %*% u_xs[,1])
}

u_s_s <- matrix(data = NA, nrow=n, ncol=n_sim)
#loc.data2 <- c()
for(i in 1:n_sim){
  set.seed(i + n_sim)
  #loc.data2[[i]] = matrix(runif(2*n), n)*10 
  B = inla.spde.make.A(mesh=mesh.sim, loc=loc.data[[i]])
  u_s_s[,i] = drop(B %*% u_s[,1])
}


#u_s_x = 2*drop(A %*% u[,51:100])

quilt.plot(x=loc.data[[1]][,1],y=loc.data[[1]][,2],z=u_s_xs[,1],nx=80,ny=80, 
           col = plasma(101), main="Field projected to data locations", 
           zlim = range(u_s_xs))

quilt.plot(x=loc.data[[1]][,1],y=loc.data[[1]][,2],z=u_s_s[,1],nx=80,ny=80, 
           col = plasma(101), main="Field projected to data locations", 
           zlim = range(u_s_s))

#plotvario(u_s_xs[,1], loc.data[[1]])
#plotvario(u_s_s[,1], loc.data[[1]])

test <- c()
test$lon <- loc.data[[1]][,1]
test$lat <- loc.data[[1]][,2]
testdf <- as.data.frame(test)
testdf$u_s <- u_s_s[,1]
testdf$u_xs <- u_s_xs[,1]
testdf$dif <- -u_s_xs[,1]-u_s_s[,1]

testdfsf <- testdf %>% sf::st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE) %>%
    sf::st_transform("EPSG:4326") 


plot(gstat::variogram(0.35*(u_xs- mean(u_xs))~1 , testdfsf))
plot(gstat::variogram(0.275*(u_s - mean(u_s))~1 , testdfsf))
#plot(gstat::variogram(dif~1 , testdfsf))

#plotvario(u_s, loc.data)
#plotvario(u_s_x, loc.data)
```

# Résidus
```{r, warning = FALSE}
generate_epsilon <- function() {
   rnorm(n, mean = 0, sd = 1)
}

# Utiliser lapply pour générer 50 ensembles epsilon
epsilon_list <- lapply(1:n_sim, function(x) generate_epsilon())

epsilon <- as(do.call(cbind,epsilon_list), "dgeMatrix")
plot(density(epsilon_list[[1]]))
```

# Covariable X
```{r, message = FALSE, warning = FALSE}
generate_epsilon_x <- function() {
   rnorm(n, mean = 0, sd = 0.1)
}
# Utiliser lapply pour générer 50 ensembles epsilon
epsilon_list_x <- lapply(1:n_sim, function(x) generate_epsilon_x())

epsilon_x <- as(do.call(cbind,epsilon_list_x), "dgeMatrix")

x <- 0.35*(u_s_xs - mean(u_s_xs)) + epsilon_x

#plotvario(x, loc.data= loc.data)
```


# Y
```{r}
ux <- (u_s_xs - mean(u_s_xs))
us <- 0.275*(u_s_s - mean(u_s_s))
Z <- us-ux
y = beta*x + Z + epsilon
#plotvario(u, loc.data = loc.data)
```

# Dataframe
```{r}
df_list <- lapply(1:n_sim, function(i) {
  data.frame(y = as.matrix(y)[, i],
             locx = loc.data[[i]][, 1],
             locy = loc.data[[i]][, 2],
             x = as.matrix(x)[, i],
             Z = as.matrix(Z)[, i])
})


df_sf_list <- lapply(df_list, function(df) {
  df %>% 
    sf::st_as_sf(coords = c("locx", "locy"), crs = 4326, remove = FALSE) #%>%
    #sf::st_transform("EPSG:2154")
})

test <- lapply(df_sf_list, function(sf_obj) {
  coords <- sf::st_coordinates(sf_obj)
  as.data.frame(coords)
})


#indice de Moran

plot(gstat::variogram(x~1 , df_list[[1]], locations = ~ locx + locy))
plot(gstat::variogram(y~1 , df_list[[1]], locations = ~ locx + locy))
plot(gstat::variogram(Z~1 , df_list[[1]], locations = ~ locx + locy))
Moran_I(data = df_list[[1]], test = df_list[[1]]$x, k=5)
Moran_I(data = df_list[[1]], test = df_list[[1]]$y, k=5)
plot(df_list[[1]]$x,df_list[[1]]$y)
#cor(df_list[[1]]$x  ,df_list[[1]]$y)
```


# Simulations
## Mesh
```{r}
mesh = inla.mesh.2d(loc = fake.locations, max.edge=c(0.61, 1))
```

# SPDE
```{r}
#spde_spat <- inla.spde2.pcmatern(
#  mesh = mesh,
#  prior.range = c(1, 0.5),#c(100 , 0.75),   
#  prior.sigma = c(1, 0.5)#c(1 , 0.25)       
#)

rm(A,B,crs1, epsilon, epsilon_list, fake.locations, Qu_s, Qu_xs, spde_s,spde_xs, test,testdf,testdfsf, u_s, u_s_s, u_s_xs, u_xs, us, ux, x, y, Z)
```

# model spatial
```{r, warning = FALSE}
spde_spatial <- inla.spde2.pcmatern(
  mesh = mesh,
  prior.range = c(0.05, 0.05),  # P(range < 0.05) = 0.01
  prior.sigma = c(3, 0.05)   # P(sigma > 2) = 0.01
)


plan(multisession, workers = 4) 

model_function_spatial <- function(i) {
  bru(y ~ 0 +  x + u_spa(geometry, model = spde_spatial), family = "gaussian", data = df_sf_list[[i]])
}

# Apply the function to each element in parallel
model_spatial <- furrr::future_map(1:n_sim, model_function_spatial)


# beta model spatial
bru_beta_spatial <-list()
bru_beta_spatial <- sapply(1:n_sim, function(i) model_spatial[[i]]$summary.fixed$mean)
bru_beta_spatial <- as.data.frame(bru_beta_spatial) %>% rename(value = "bru_beta_spatial")
bru_beta_spatial$Group <- rep(c("beta spatial"), each=n_sim)

# beta sd model spatial
bru_beta_sd_spatial <-list()
bru_beta_sd_spatial <- sapply(1:n_sim, function(i) model_spatial[[i]]$summary.fixed$sd)
bru_beta_sd_spatial <- as.data.frame(bru_beta_sd_spatial) %>% rename(value = "bru_beta_sd_spatial")
bru_beta_sd_spatial$Group <- rep(c("beta sd spatial"), each=n_sim)

#range u
bru_u_spatial <-list()
bru_u_spatial <- sapply(1:n_sim, function(i) model_spatial[[i]]$summary.hyperpar$mean[2])
bru_u_spatial <- as.data.frame(bru_u_spatial) %>% rename(value = "bru_u_spatial")
bru_u_spatial$Group <- rep(c("u spatial"), each=n_sim)


#sd u
bru_u_sd_spatial <-list()
bru_u_sd_spatial <- sapply(1:n_sim, function(i) model_spatial[[i]]$summary.hyperpar$sd[2])
bru_u_sd_spatial <- as.data.frame(bru_u_sd_spatial) %>% rename(value = "bru_u_sd_spatial")
bru_u_sd_spatial$Group <- rep(c("u sd spatial"), each=n_sim)

calculate_expression <- function(df, model) {
  mean((df$y - model$summary.fitted.values[1:n,]$mean)^2)
}

# MSE model spatial
MSE_model_spatial <- c()
MSE_model_spatial <- lapply(seq_along(df_list), function(i) {
  calculate_expression(df_list[[i]], model_spatial[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_model_spatial) <- "value"
MSE_model_spatial$Group <- rep(c("MSE spatial"), each=n_sim)

# MSE beta model spatial
MSE_beta <- function(beta, model) {
  mean((beta - model$summary.fixed$mean)^2)
}

MSE_beta_model_spatial <- c()
MSE_beta_model_spatial <- lapply(seq_along(df_list), function(i) {
  MSE_beta(beta, model_spatial[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_beta_model_spatial) <- "value"
MSE_beta_model_spatial$Group <- rep(c("MSE beta spatial"), each=n_sim)


#WAIC
WAIC_model_spatial <- c()
WAIC_model_spatial <- lapply(1:n_sim, function(i) model_spatial[[i]]$waic$waic) %>% unlist() %>%  as.data.frame()

names(WAIC_model_spatial) <- "value"
WAIC_model_spatial$Group <- rep(c("WAIC spatial"), each=n_sim)

#DIC
DIC_model_spatial <- c()
DIC_model_spatial <- lapply(1:n_sim, function(i) model_spatial[[i]]$dic$dic) %>% unlist() %>%  as.data.frame()

names(DIC_model_spatial) <- "value"
DIC_model_spatial$Group <- rep(c("DIC spatial"), each=n_sim)

#CI
CI_spatial <- CI(model_spatial)

#significativite
signif_spatial <- signif(model_spatial)

plot_marginal(model_spatial)
```

# model NULL
```{r, warning = FALSE}
plan(multisession, workers = 4) 
model_function_NULL <- function(i) {
  bru(y ~ 0 +  x , family = "gaussian", data = df_sf_list[[i]])
}

model_NULL <- furrr::future_map(1:n_sim, model_function_NULL)


test_NULL <- lapply(df_sf_list, function(df) lm(y ~ 0 + x, data = df))

# beta model NULL
bru_beta_NULL <-list()
bru_beta_NULL <- sapply(1:n_sim, function(i) model_NULL[[i]]$summary.fixed$mean)
bru_beta_NULL <- as.data.frame(bru_beta_NULL) %>% rename(value = "bru_beta_NULL")
bru_beta_NULL$Group <- rep(c("beta NULL"), each=n_sim)

# beta sd model NULL
bru_beta_sd_NULL <-list()
bru_beta_sd_NULL <- sapply(1:n_sim, function(i) model_NULL[[i]]$summary.fixed$sd)
bru_beta_sd_NULL <- as.data.frame(bru_beta_sd_NULL) %>% rename(value = "bru_beta_sd_NULL")
bru_beta_sd_NULL$Group <- rep(c("beta sd NULL"), each=n_sim)

#range u
bru_u_NULL <-list()
bru_u_NULL <- sapply(1:n_sim, function(i) model_NULL[[i]]$summary.hyperpar$mean[2])
bru_u_NULL <- as.data.frame(bru_u_NULL) %>% rename(value = "bru_u_NULL")
bru_u_NULL$Group <- rep(c("u NULL"), each=n_sim)


#sd u
bru_u_sd_NULL <-list()
bru_u_sd_NULL <- sapply(1:n_sim, function(i) model_NULL[[i]]$summary.hyperpar$sd[2])
bru_u_sd_NULL <- as.data.frame(bru_u_sd_NULL) %>% rename(value = "bru_u_sd_NULL")
bru_u_sd_NULL$Group <- rep(c("u sd NULL"), each=n_sim)


# MSE model NULL
calculate_expression_NULL <- function(df, model) {
  mean((df$y - model$summary.fitted.values$mean)^2)
}

# Use lapply to loop over df_list and model_NULL simultaneously
MSE_model_NULL <- c()
MSE_model_NULL <- lapply(seq_along(df_list), function(i) {
  calculate_expression_NULL(df_list[[i]], model_NULL[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_model_NULL) <- "value"
MSE_model_NULL$Group <- rep(c("MSE NULL"), each=n_sim)


# MSE beta model NULL
MSE_beta <- function(beta, model) {
  mean((beta - model$summary.fixed$mean)^2)
}

MSE_beta_model_NULL <- c()
MSE_beta_model_NULL <- lapply(seq_along(df_list), function(i) {
  MSE_beta(beta, model_NULL[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_beta_model_NULL) <- "value"
MSE_beta_model_NULL$Group <- rep(c("MSE beta NULL"), each=n_sim)



#WAIC
WAIC_model_NULL <- c()
WAIC_model_NULL <- lapply(1:n_sim, function(i) model_NULL[[i]]$waic$waic) %>% unlist() %>%  as.data.frame()

names(WAIC_model_NULL) <- "value"
WAIC_model_NULL$Group <- rep(c("WAIC NULL"), each=n_sim)

#DIC
DIC_model_NULL <- c()
DIC_model_NULL <- lapply(1:n_sim, function(i) model_NULL[[i]]$dic$dic) %>% unlist() %>%  as.data.frame()

names(DIC_model_NULL) <- "value"
DIC_model_NULL$Group <- rep(c("DIC NULL"), each=n_sim)

#CI
CI_NULL <- CI(model_NULL)

#significativite
signif_NULL <- signif(model_NULL)

plot_marginal(model_NULL)



rm(model_function_NULL, model_NULL)
```

# model RSR
```{r}
# Method Lindgren

# iid prior
#pc_prec <- list(prior = "pcprec", param = c(3, 0.1))
#, model = "iid", constr= TRUE, hyper = list(prec = pc_prec)
#, model='linear', mean.linear=0, prec.linear=.1
spde_RSR <- inla.spde2.pcmatern(
  mesh = mesh,
  prior.range = c(15, .9999),
  prior.sigma = c(1.5, .0001)
)


plan(multisession, workers = 4) 


model_function_RSR <- function(i) {
  bru( components = ~  0 + X_Effect(x) + u(geometry, model = spde_RSR),
    like(
        formula = y ~ 0 + X_Effect + u - x*sum(x*u)/sum(x^2), 
        family = "gaussian",
        data = df_sf_list[[i]]
    ),
    options = list(
            control.compute = list(waic = TRUE, cpo = FALSE),
            control.inla = list(int.strategy = "eb"),
            verbose = FALSE
        ))
}

model_RSR <- furrr::future_map(1:n_sim, model_function_RSR,.options = furrr_options(seed = TRUE))

# beta model RSR
bru_beta_RSR <- list()
bru_beta_RSR <- sapply(1:n_sim, function(i) model_RSR[[i]]$summary.fixed$mean)
bru_beta_RSR <- as.data.frame(bru_beta_RSR) %>% rename(value = "bru_beta_RSR")
bru_beta_RSR$Group <- rep(c("beta RSR"), each=n_sim)

# beta sd model RSR
bru_beta_sd_RSR <-list()
bru_beta_sd_RSR <- sapply(1:n_sim, function(i) model_RSR[[i]]$summary.fixed$sd)
bru_beta_sd_RSR <- as.data.frame(bru_beta_sd_RSR) %>% rename(value = "bru_beta_sd_RSR")
bru_beta_sd_RSR$Group <- rep(c("beta sd RSR"), each=n_sim)

#range u
bru_u_RSR <-list()
bru_u_RSR <- sapply(1:n_sim, function(i) model_RSR[[i]]$summary.hyperpar$mean[2])
bru_u_RSR <- as.data.frame(bru_u_RSR) %>% rename(value = "bru_u_RSR")
bru_u_RSR$Group <- rep(c("u RSR"), each=n_sim)


#sd u
bru_u_sd_RSR <-list()
bru_u_sd_RSR <- sapply(1:n_sim, function(i) model_RSR[[i]]$summary.hyperpar$sd[2])
bru_u_sd_RSR <- as.data.frame(bru_u_sd_RSR) %>% rename(value = "bru_u_sd_RSR")
bru_u_sd_RSR$Group <- rep(c("u sd RSR"), each=n_sim)


# MSE model RSR
MSE_model_RSR <- c()
MSE_model_RSR <- lapply(seq_along(df_list), function(i) {
  calculate_expression(df_list[[i]], model_RSR[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_model_RSR) <- "value"
MSE_model_RSR$Group <- rep(c("MSE RSR"), each=n_sim)

# MSE beta model RSR
MSE_beta_model_RSR  <- c()
MSE_beta_model_RSR <- lapply(seq_along(df_list), function(i) {
  MSE_beta(beta, model_RSR[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_beta_model_RSR) <- "value"
MSE_beta_model_RSR$Group <- rep(c("MSE beta RSR"), each=n_sim)


#WAIC
WAIC_model_RSR <- c()
WAIC_model_RSR <- lapply(1:n_sim, function(i) model_RSR[[i]]$waic$waic) %>% unlist() %>%  as.data.frame()

names(WAIC_model_RSR) <- "value"
WAIC_model_RSR$Group <- rep(c("WAIC RSR"), each=n_sim)

#DIC
DIC_model_RSR <- c()
DIC_model_RSR <- lapply(1:n_sim, function(i) model_RSR[[i]]$dic$dic) %>% unlist() %>%  as.data.frame()

names(DIC_model_RSR) <- "value"
DIC_model_RSR$Group <- rep(c("DIC RSR"), each=n_sim)

#CI
CI_RSR <- CI(model_RSR)

#significativite
signif_RSR <- signif(model_RSR)


plot_marginal(model_RSR)


rm(model_function_RSR, model_RSR)
```

# model spatial + 
```{r, warning = FALSE, message = FALSE}

spde_spatialplus <- inla.spde2.pcmatern(
  mesh = mesh,
  prior.range = c(0.05, 0.5),
  prior.sigma = c(.25, 0.5)
)


spde_spat <- inla.spde2.pcmatern(
  mesh = mesh,
  prior.range = c(0.01, 0.01),   # P(range < 5) = 0.5
  prior.sigma = c(0.15, 0.01)     # P(sigma > 1) = 0.5
)


plan(multisession, workers = 4) 

#x_fit <- lapply(df_sf_list, function(df) lm(x ~ -1 + locx + locy, data = df))

x_fit <- lapply(df_sf_list, function(df) bru(x ~ 0 + u(geometry, model = spde_spat), data = df))

x_true<- lapply(df_list, function(i) i$x)

df_sf_list_new <- mapply(function(df, true, fit) {
  df$fitted_x_bru <- true - fit$summary.fitted.values[1:n,]$mean
  return(df)
}, df_sf_list, x_true, x_fit) %>% as.data.frame()


plan(multisession, workers = 4) 
model_function_spatial_plus <- function(i) {
  bru(y ~ 0 +  fitted_x_bru  +
    u(geometry, model = spde_spatial),
    family = "gaussian", data = df_sf_list_new[[i]])
}
model_spatial_plus <- furrr::future_map(1:n_sim, model_function_spatial_plus)#lapply(1:n_sim, model_function_spatial_plus)#

# beta model spatial plus
bru_beta_spatial_plus <-list()
bru_beta_spatial_plus <- sapply(1:n_sim, function(i) model_spatial_plus[[i]]$summary.fixed$mean)
bru_beta_spatial_plus <- as.data.frame(bru_beta_spatial_plus) %>% rename(value = "bru_beta_spatial_plus")
bru_beta_spatial_plus$Group <- rep(c("beta spatial plus"), each=n_sim)

# beta sd model spatial plus
bru_beta_sd_spatial_plus <-list()
bru_beta_sd_spatial_plus <- sapply(1:n_sim, function(i) model_spatial_plus[[i]]$summary.fixed$sd)
bru_beta_sd_spatial_plus <- as.data.frame(bru_beta_sd_spatial_plus) %>% rename(value = "bru_beta_sd_spatial_plus")
bru_beta_sd_spatial_plus$Group <- rep(c("beta sd spatial plus"), each=n_sim)

#range u
bru_u_spatial_plus  <-list()
bru_u_spatial_plus <- sapply(1:n_sim, function(i) model_spatial_plus[[i]]$summary.hyperpar$mean[2])
bru_u_spatial_plus <- as.data.frame(bru_u_spatial_plus) %>% rename(value = "bru_u_spatial_plus")
bru_u_spatial_plus$Group <- rep(c("u spatial plus"), each=n_sim)


#sd u
bru_u_sd_spatial_plus <-list()
bru_u_sd_spatial_plus <- sapply(1:n_sim, function(i) model_spatial_plus[[i]]$summary.hyperpar$sd[2])
bru_u_sd_spatial_plus <- as.data.frame(bru_u_sd_spatial_plus) %>% rename(value = "bru_u_sd_spatial_plus")
bru_u_sd_spatial_plus$Group <- rep(c("u sd spatial plus"), each=n_sim)


# MSE model spatial plus
MSE_model_spatial_plus <- c()
MSE_model_spatial_plus <- lapply(seq_along(df_list), function(i) {
  calculate_expression(df_list[[i]], model_spatial_plus[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_model_spatial_plus) <- "value"
MSE_model_spatial_plus$Group <- rep(c("MSE spatial plus"), each=n_sim)

# MSE beta model spatial plus
MSE_beta_spatial_plus  <- c()
MSE_beta_spatial_plus <- lapply(seq_along(df_list), function(i) {
  MSE_beta(beta, model_spatial_plus[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_beta_spatial_plus) <- "value"
MSE_beta_spatial_plus$Group <- rep(c("MSE beta spatial plus"), each=n_sim)



#WAIC
WAIC_model_spatial_plus<- c()
WAIC_model_spatial_plus <- lapply(1:n_sim, function(i) model_spatial_plus[[i]]$waic$waic) %>% unlist() %>%  as.data.frame()

names(WAIC_model_spatial_plus) <- "value"
WAIC_model_spatial_plus$Group <- rep(c("WAIC spatial plus"), each=n_sim)

#DIC
DIC_model_spatial_plus<- c()
DIC_model_spatial_plus <- lapply(1:n_sim, function(i) model_spatial_plus[[i]]$dic$dic) %>% unlist() %>%  as.data.frame()

names(DIC_model_spatial_plus) <- "value"
DIC_model_spatial_plus$Group <- rep(c("DIC spatial plus"), each=n_sim)

#CI
CI_spatial_plus <- CI(model_spatial_plus)

#significativite
signif_spatial_plus <- signif(model_spatial_plus)

plot_marginal(model_spatial_plus)

rm(model_x_fit, x_fit, x_true, fitted_x_bru, df_sf_list_new, model_function_spatial_plus, model_spatial_plus)
```

# model spatial + V2 
```{r, warning = FALSE, message = FALSE}
spde_spatialplus2 <- inla.spde2.pcmatern(
  mesh = mesh,
  prior.range = c(0.05, 0.01),
  prior.sigma = c(2, 0.01)
)


dist <- lapply(df_list, function(df) sp::spDists(coordinates(df[, c("locx", "locy")])))

#Q <- mapply(function(distance, log_r_u) inla.matern.cov(nu = 1, kappa = sqrt(8)/13, distance), dist, log_range_u, SIMPLIFY = FALSE)
Q <- lapply(1:n_sim, function(i) inla.matern.cov(nu = 1/2, kappa = 3.1, dist[[i]]))
Q_inv <- lapply(Q, function(i) solve(i))
r <-  lapply(Q_inv, function(i) eigen(i)) # spectral decomposition
eigen.vect <- lapply(r, function(i) i$vectors) # eigen vectors

# find the decomposition in eigen vector
coef <- lapply(1:n_sim, function(i) solve(eigen.vect[[i]], df_sf_list[[i]]$x))
#coef <- mapply(function(e_vect, df)  solve(e_vect, df$x), eigen.vect, df_list, SIMPLIFY = FALSE)

model_spatial_plus2 <- lapply(1:n_sim, function(i) fit_with_eigen_vectors(nbr_eigen_vectors = 400, data = df_sf_list[[i]], decomposition=coef[[i]], e_vect = eigen.vect[[i]]))

#make_boxplot_sensiblity(max = 500, min = 1, precision = 5, mod = fit_with_eigen_vectors(nbr_eigen_vectors = n, data = df_sf_list[[2]], decomposition=coef[[2]], e_vect #= eigen.vect[[2]]))

# beta model spatial plus V2
bru_beta_spatial_plus2 <-list()
bru_beta_spatial_plus2 <- sapply(1:n_sim, function(i) model_spatial_plus2[[i]]$summary.fixed$mean)
bru_beta_spatial_plus2 <- as.data.frame(bru_beta_spatial_plus2) %>% rename(value = "bru_beta_spatial_plus2")
bru_beta_spatial_plus2$Group <- rep(c("beta spatial plus V2"), each=n_sim)

# beta sd model spatial plus V2
bru_beta_sd_spatial_plus2 <-list()
bru_beta_sd_spatial_plus2 <- sapply(1:n_sim, function(i) model_spatial_plus2[[i]]$summary.fixed$sd)
bru_beta_sd_spatial_plus2 <- as.data.frame(bru_beta_sd_spatial_plus2) %>% rename(value = "bru_beta_sd_spatial_plus2")
bru_beta_sd_spatial_plus2$Group <- rep(c("beta sd spatial plus V2"), each=n_sim)

#range u
bru_u_spatial_plus2  <-list()
bru_u_spatial_plus2 <- sapply(1:n_sim, function(i) model_spatial_plus2[[i]]$summary.hyperpar$mean[2])
bru_u_spatial_plus2 <- as.data.frame(bru_u_spatial_plus2) %>% rename(value = "bru_u_spatial_plus2")
bru_u_spatial_plus2$Group <- rep(c("u spatial plus V2"), each=n_sim)


#sd u
bru_u_sd_spatial_plus2 <-list()
bru_u_sd_spatial_plus2 <- sapply(1:n_sim, function(i) model_spatial_plus2[[i]]$summary.hyperpar$sd[2])
bru_u_sd_spatial_plus2 <- as.data.frame(bru_u_sd_spatial_plus2) %>% rename(value = "bru_u_sd_spatial_plus2")
bru_u_sd_spatial_plus2$Group <- rep(c("u sd spatial plus V2"), each=n_sim)


# MSE model spatial plus V2
MSE_model_spatial_plus2 <- c()
MSE_model_spatial_plus2 <- lapply(seq_along(df_list), function(i) {
  calculate_expression(df_list[[i]], model_spatial_plus2[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_model_spatial_plus2) <- "value"
MSE_model_spatial_plus2$Group <- rep(c("MSE spatial plus V2"), each=n_sim)

# MSE beta model spatial plus V2
MSE_beta_spatial_plus2  <- c()
MSE_beta_spatial_plus2 <- lapply(seq_along(df_list), function(i) {
  MSE_beta(beta, model_spatial_plus2[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_beta_spatial_plus2) <- "value"
MSE_beta_spatial_plus2$Group <- rep(c("MSE beta spatial plus V2"), each=n_sim)


#WAIC
WAIC_model_spatial_plus2<- c()
WAIC_model_spatial_plus2 <- lapply(1:n_sim, function(i) model_spatial_plus2[[i]]$waic$waic) %>% unlist() %>%  as.data.frame()

names(WAIC_model_spatial_plus2) <- "value"
WAIC_model_spatial_plus2$Group <- rep(c("WAIC spatial plus V2"), each=n_sim)

#DIC
DIC_model_spatial_plus2<- c()
DIC_model_spatial_plus2 <- lapply(1:n_sim, function(i) model_spatial_plus2[[i]]$dic$dic) %>% unlist() %>%  as.data.frame()

names(DIC_model_spatial_plus2) <- "value"
DIC_model_spatial_plus2$Group <- rep(c("DIC spatial plus V2"), each=n_sim)

#CI
CI_spatial_plus2 <- CI(model_spatial_plus2)

#significativite
signif_spatial_plus2 <- signif(model_spatial_plus2)

plot_marginal(model_spatial_plus2)


rm(hyperparam, log_range_u, log_sigma_u, dist, Q, r, coef, model_spatial_plus2)
```

# model SVC
```{r, warning = FALSE, message = FALSE}
plan(multisession, workers = 4) 

model_function_SVC <- function(i) {
  bru(y ~ -1 + x_spa(geometry,  weights = x, model = spde_spatial) + u_spa(geometry, model = spde_spatial), family = "gaussian", data = df_sf_list[[i]])
}

# Apply the function to each element in parallel
model_SVC <- furrr::future_map(1:n_sim, model_function_SVC)

bru_beta_SVC <- data.frame(value = rep(NA, n_sim), Group = rep(c("beta SVC"), each=n_sim))
bru_beta_sd_SVC <- data.frame(value = rep(NA, n_sim), Group = rep(c("beta sd SVC"), each=n_sim))

#range u
bru_u_SVC  <-list()
bru_u_SVC <- sapply(1:n_sim, function(i) model_SVC[[i]]$summary.hyperpar$mean[2])
bru_u_SVC <- as.data.frame(bru_u_SVC) %>% rename(value = "bru_u_SVC")
bru_u_SVC$Group <- rep(c("u SVC"), each=n_sim)


#sd u
bru_u_sd_SVC <-list()
bru_u_sd_SVC <- sapply(1:n_sim, function(i) model_SVC[[i]]$summary.hyperpar$sd[2])
bru_u_sd_SVC <- as.data.frame(bru_u_sd_SVC) %>% rename(value = "bru_u_sd_SVC")
bru_u_sd_SVC$Group <- rep(c("u sd SVC"), each=n_sim)



# MSE model SVC
MSE_model_SVC<- c()
MSE_model_SVC <- lapply(seq_along(df_list), function(i) {
  calculate_expression(df_list[[i]], model_SVC[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_model_SVC) <- "value"
MSE_model_SVC$Group <- rep(c("MSE SVC"), each=n_sim)

# MSE beta model SVC
MSE_beta_SVC <- c()
MSE_beta_SVC <- lapply(seq_along(df_list), function(i) {
  MSE_beta(beta, model_SVC[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_beta_SVC) <- "value"
MSE_beta_SVC$Group <- rep(c("MSE beta SVC"), each=n_sim)


#WAIC
WAIC_model_SVC<- c()
WAIC_model_SVC <- lapply(1:n_sim, function(i) model_SVC[[i]]$waic$waic) %>% unlist() %>%  as.data.frame()

names(WAIC_model_SVC) <- "value"
WAIC_model_SVC$Group <- rep(c("WAIC SVC"), each=n_sim)

#DIC
DIC_model_SVC<- c()
DIC_model_SVC <- lapply(1:n_sim, function(i) model_SVC[[i]]$dic$dic) %>% unlist() %>%  as.data.frame()

names(DIC_model_SVC) <- "value"
DIC_model_SVC$Group <- rep(c("DIC SVC"), each=n_sim)

#CI
CI_SVC <- NA

#significativite
signif_SVC <- NA

rm(model_function_SVC, model_SVC)
```

# model SVC plus
```{r, warning = FALSE, message = FALSE}

spde_SVCplus_beta <- inla.spde2.pcmatern(
  mesh = mesh,
  prior.range = c(7.5, 0.5),
  prior.sigma = c(.05, 0.5)
)

spde_SVCplus_u <- inla.spde2.pcmatern(
  mesh = mesh,
  prior.range = c(7.5, 0.5),
  prior.sigma = c(.75, 0.5)
)



plan(multisession, workers = 4) 

model_function_SVC_plus <- function(i) {
  bru(y ~ -1 + x + x_spa(geometry,  weights = x, model = spde_spatial) + u_spa(geometry, model = spde_spatial), family = "gaussian", data = df_sf_list[[i]])
}

# Apply the function to each element in parallel
model_SVC_plus <- furrr::future_map(1:n_sim, model_function_SVC_plus)


# beta model SVC plus
bru_beta_SVC_plus<-list()
bru_beta_SVC_plus <- sapply(1:n_sim, function(i) model_SVC_plus[[i]]$summary.fixed$mean)
bru_beta_SVC_plus <- as.data.frame(bru_beta_SVC_plus) %>% rename(value = "bru_beta_SVC_plus")
bru_beta_SVC_plus$Group <- rep(c("beta SVC plus"), each=n_sim)

# beta sd model SVC plus
bru_beta_sd_SVC_plus <-list()
bru_beta_sd_SVC_plus <- sapply(1:n_sim, function(i) model_SVC_plus[[i]]$summary.fixed$sd)
bru_beta_sd_SVC_plus <- as.data.frame(bru_beta_sd_SVC_plus) %>% rename(value = "bru_beta_sd_SVC_plus")
bru_beta_sd_SVC_plus$Group <- rep(c("beta sd SVC plus"), each=n_sim)

#range u
bru_u_SVC_plus  <-list()
bru_u_SVC_plus <- sapply(1:n_sim, function(i) model_SVC_plus[[i]]$summary.hyperpar$mean[2])
bru_u_SVC_plus <- as.data.frame(bru_u_SVC_plus) %>% rename(value = "bru_u_SVC_plus")
bru_u_SVC_plus$Group <- rep(c("u SVC plus"), each=n_sim)


#sd u
bru_u_sd_SVC_plus <-list()
bru_u_sd_SVC_plus <- sapply(1:n_sim, function(i) model_SVC_plus[[i]]$summary.hyperpar$sd[2])
bru_u_sd_SVC_plus <- as.data.frame(bru_u_sd_SVC_plus) %>% rename(value = "bru_u_sd_SVC_plus")
bru_u_sd_SVC_plus$Group <- rep(c("u sd SVC plus"), each=n_sim)


# MSE model SVC plus
MSE_model_SVC_plus <- c()
MSE_model_SVC_plus <- lapply(seq_along(df_list), function(i) {
  calculate_expression(df_list[[i]], model_SVC_plus[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_model_SVC_plus) <- "value"
MSE_model_SVC_plus$Group <- rep(c("MSE SVC plus"), each=n_sim)

# MSE beta model SVC
MSE_beta_SVC_plus <- c()
MSE_beta_SVC_plus <- lapply(seq_along(df_list), function(i) {
  MSE_beta(beta, model_SVC_plus[[i]])
}) %>% unlist() %>%  as.data.frame()

names(MSE_beta_SVC_plus) <- "value"
MSE_beta_SVC_plus$Group <- rep(c("MSE beta SVC plus"), each=n_sim)


#WAIC
WAIC_model_SVC_plus<- c()
WAIC_model_SVC_plus <- lapply(1:n_sim, function(i) model_SVC_plus[[i]]$waic$waic) %>% unlist() %>%  as.data.frame()

names(WAIC_model_SVC_plus) <- "value"
WAIC_model_SVC_plus$Group <- rep(c("WAIC SVC plus"), each=n_sim)

#DIC
DIC_model_SVC_plus<- c()
DIC_model_SVC_plus <- lapply(1:n_sim, function(i) model_SVC_plus[[i]]$dic$dic) %>% unlist() %>%  as.data.frame()

names(DIC_model_SVC_plus) <- "value"
DIC_model_SVC_plus$Group <- rep(c("DIC SVC plus"), each=n_sim)

#CI
CI_SVC_plus <- CI(model_SVC_plus)

#significativite
signif_SVC_plus<- signif(model_SVC_plus)


plot_marginal(model_SVC_plus)
                               
rm(model_function_SVC_plus, model_SVC_plus)
```

# Affichage beta
```{r}
combined <- rbind(bru_beta_NULL, bru_beta_spatial, bru_beta_RSR, bru_beta_spatial_plus, bru_beta_spatial_plus2, bru_beta_SVC_plus, bru_beta_SVC)

ggplot(combined, aes(x = "", y = value, fill=Group)) +
  geom_blank(data = subset(combined, Group == "beta SVC")) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  #scale_fill_discrete(breaks=c('beta NULL', 'beta RSR i', 'beta spatial', "beta spatial plus", "beta spatial plus V2", "beta SVC plus", "beta SVC")) +
  labs(x = "", y = "Value", title = "Boxplot posterior beta") +
  geom_hline(yintercept = beta, linetype = "dashed", color= "red") +
  #guides(fill = guide_legend(override.aes = list(alpha = c(1, 1, 1, 1, 1, 1, 0)))) +
  theme_minimal()

```

# Affichage sd beta
```{r}
combined_sd <- rbind(bru_beta_sd_NULL, bru_beta_sd_spatial, bru_beta_sd_RSR, bru_beta_sd_spatial_plus, bru_beta_sd_spatial_plus2, bru_beta_sd_SVC_plus, bru_beta_sd_SVC)

ggplot(combined_sd, aes(x = "", y = value, fill=Group)) +
  geom_blank(data = subset(combined_sd, Group == "beta sd SVC")) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  #scale_fill_discrete(breaks=c('beta NULL', 'beta RSR i', 'beta spatial', "beta spatial plus", "beta spatial plus V2", "beta SVC plus", "beta SVC")) +
  labs(x = "", y = "Value", title = "Boxplot posterior beta sd") +
  #geom_hline(yintercept = beta, linetype = "dashed", color= "red") +
  #guides(fill = guide_legend(override.aes = list(alpha = c(1, 1, 1, 1, 1, 1, 0)))) +
  theme_minimal()

```



# Affichage u
```{r}
combined_u <- rbind(bru_u_NULL, bru_u_RSR, bru_u_spatial, bru_u_spatial_plus, bru_u_spatial_plus2, bru_u_SVC, bru_u_SVC_plus)

ggplot(combined_u, aes(x = "", y = value, fill=Group)) +
  #geom_blank(data = subset(combined, Group == "u SVC")) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  #scale_fill_discrete(breaks=c('beta NULL', 'beta RSR i', 'beta spatial', "beta spatial plus", "beta spatial plus V2", "beta SVC plus", "beta SVC")) +
  labs(x = "", y = "Value", title = "Boxplot posterior u") +
  geom_hline(yintercept = beta, linetype = "dashed", color= "red") +
  #guides(fill = guide_legend(override.aes = list(alpha = c(1, 1, 1, 1, 1, 1, 0)))) +
  theme_minimal()

```


# Affichage sd u
```{r}
combined_sd_u <- rbind(bru_u_sd_NULL, bru_u_sd_RSR, bru_u_sd_spatial, bru_u_sd_spatial_plus, bru_u_sd_spatial_plus2, bru_u_sd_SVC, bru_u_sd_SVC_plus)

ggplot(combined_sd_u, aes(x = "", y = value, fill=Group)) +
  #geom_blank(data = subset(combined_sd, Group == "u sd SVC")) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  #scale_fill_discrete(breaks=c('beta NULL', 'beta RSR i', 'beta spatial', "beta spatial plus", "beta spatial plus V2", "beta SVC plus", "beta SVC")) +
  labs(x = "", y = "Value", title = "Boxplot posterior u sd") +
  #geom_hline(yintercept = beta, linetype = "dashed", color= "red") +
  #guides(fill = guide_legend(override.aes = list(alpha = c(1, 1, 1, 1, 1, 1, 0)))) +
  theme_minimal()

```

# Affichage MSE
```{r, warning=FALSE}
combined_MSE <- rbind(MSE_model_NULL, MSE_model_spatial, MSE_model_RSR, MSE_model_spatial_plus, MSE_model_spatial_plus2, MSE_model_SVC, MSE_model_SVC_plus)

ggplot(combined_MSE, aes(x = "", y = value, fill=Group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  labs(x = "", y = "Value", title = "Boxplot MSE") +
  theme_minimal()
```

# Affichage MSE Beta
```{r, warning=FALSE}
combined_MSE_beta <- rbind(MSE_beta_model_NULL, MSE_beta_model_spatial, MSE_beta_model_RSR, MSE_beta_spatial_plus, MSE_beta_spatial_plus2, MSE_beta_SVC, MSE_beta_SVC_plus)

ggplot(combined_MSE_beta, aes(x = "", y = value, fill=Group)) +
  geom_blank(data = subset(combined_MSE_beta, Group == "MSE beta SVC")) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  labs(x = "", y = "Value", title = "Boxplot MSE Beta") +
  theme_minimal()
```


# Affichage WAIC
```{r, warning=FALSE}
combined_WAIC <- rbind(WAIC_model_NULL, WAIC_model_spatial, WAIC_model_RSR, WAIC_model_spatial_plus, WAIC_model_spatial_plus2, WAIC_model_SVC, WAIC_model_SVC_plus)

ggplot(combined_WAIC, aes(x = "", y = value, fill=Group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  labs(x = "", y = "Value", title = "Boxplot WAIC") +
  theme_minimal()
```

# Affichage DIC
```{r, warning=FALSE}
combined_DIC <- rbind(DIC_model_NULL, DIC_model_spatial, DIC_model_RSR, DIC_model_spatial_plus, DIC_model_spatial_plus2, DIC_model_SVC, DIC_model_SVC_plus)

ggplot(combined_DIC, aes(x = "", y = value, fill=Group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  labs(x = "", y = "Value", title = "Boxplot DIC") +
  theme_minimal()
```

#Affichage CI
```{r}
combined_CI <- rbind(CI_NULL, CI_RSR, CI_spatial, CI_spatial_plus, CI_spatial_plus2, CI_SVC, CI_SVC_plus)
colnames(combined_CI) <- "value"
df <- as.data.frame(combined_CI)
df$Group <- rownames(df)
df <- df[, c("value", "Group")]
rownames(df) <- NULL

ggplot(df, aes(x = Group, y = value, fill = Group)) +
  geom_col(color = "black") +
  geom_text(aes(label = round(value, 2)), vjust = -0.5, size = 3.5) +
  labs(title = "coverage of 95% credibility intervals of beta (CI)", x = " ", y = "Frequency") +
  theme_minimal() +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(axis.text.x = element_blank())

```


#Affichage signif
```{r}
combined_signif <- rbind(signif_NULL, signif_RSR, signif_spatial, signif_spatial_plus, signif_spatial_plus2, signif_SVC, signif_SVC_plus)
colnames(combined_signif) <- "value"
df <- as.data.frame(combined_signif)
df$Group <- rownames(df)
df <- df[, c("value", "Group")]
rownames(df) <- NULL

ggplot(df, aes(x = Group, y = value, fill = Group)) +
  geom_col(color = "black") +
  geom_text(aes(label = round(value, 2)), vjust = -0.5, size = 3.5) +
  labs(title = "significant beta", x = " ", y = "Frequency") +
  theme_minimal() +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(axis.text.x = element_blank())

```

# Distribution à posteriori du beta
```{r}
plot_marginal(model_spatial)
plot_marginal(model_NULL)
plot_marginal(model_RSR)
plot_marginal(model_spatial_plus)
plot_marginal(model_spatial_plus2)
plot_marginal(model_SVC_plus)
```





